name: ğŸš€ Deploy

on:
  push:
    branches:
      - main
    paths:
      - src/**
      - themes/**
      - .github/workflows/deploy.yml
  workflow_dispatch:

permissions: {}

jobs:
  deploy:
    name: ğŸš€ Deploy
    permissions:
      contents: read
      deployments: write
    runs-on: macOS-Latest
    timeout-minutes: 2

    steps:
      - name: ğŸšš Check out repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: ğŸ Set up Bun with cache
        uses: 5ouma/utils/setup-bun-with-cache@f0d974bfa84423faffd60e4337c744fc89ade698 # v0.7.1

      - name: ğŸ› ï¸ Build
        run: bun run build

      - name: ğŸ–¼ï¸ Replace OGP path
        run: |
          while read -r file; do
            dir="$(echo "$file" | cut -d '/' -f 2- | xargs dirname)"
            sed -i '' "s?\"index.png\"?\"$url/$dir/index.png\"?g" "$file"
          done < <(find dist -name '*.html')
        env:
          url: ${{ vars.HOST_URL }}

      - name: â›…ï¸ Deploy to production
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # v3.14.1
        with:
          command: deploy --name=${{ github.event.repository.name }} --compatibility-date="$(date +%Y-%m-%d)" --assets=./dist
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
